{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
        #camera {
            width: 100%;
            height: 200px;
            background-color: #ddd;
            cursor: pointer;  /* 添加这个样式使摄像头方框可点击 */
        }
        .video-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid vh-100 d-flex">
        <div class="sidebar bg-light p-3 d-flex flex-column align-items-center">
            <img src="{% static 'img/logo.png' %}" alt="Logo" class="mb-3"  width="240">
            <ul class="nav flex-column">
                <li class="nav-item mb-3"><a id="normal-mode" class="btn btn-primary" href="{% url 'index' %}">普通模式</a></li>
                <li class="nav-item mb-3"><a id="multimodal-mode" class="btn btn-primary" href="{% url 'multimodal' %}">多模态模式</a></li>
                <li class="nav-item mb-3"><a id="motion-mode" class="btn btn-primary" href="{% url 'motion' %}">情感识别模式</a></li>
            </ul>
        </div>
        <div class="main-content flex-grow-1 p-4">
            <div id="interactive-mode-content" class="mode-content active">
                <div class="text-output border p-3 mb-3" id="text-output">
                    <!-- 这里将显示输出 -->
                </div>
                <div class="text-input border p-3 mb-3">
                    <textarea id="text-input" placeholder="在这里输入..." style="width: 100%;"></textarea>
                    <!-- 用户可以在这里输入 -->
                </div>
                <div class="action-button mb-3" style="display: flex; justify-content: center; align-items: center;">
                    <button id="action-button" class="btn btn-primary">开始对话</button>
                </div>
                <div class="video-wrapper">
                    <video id="camera" autoplay></video>
                </div>
                <script>
                    // 点击摄像头方框时打开摄像头
                    document.getElementById('camera').addEventListener('click', function() {
                        const video = document.getElementById('camera');
                        if (!video.srcObject) {
                            navigator.mediaDevices.getUserMedia({ video: true })
                                .then(stream => {
                                    video.srcObject = stream;
                                })
                                .catch(error => console.error('Error accessing camera:', error));
                        }
                    });
                
                    // 点击“开始对话”按钮时拍照并上传照片
                    document.getElementById('action-button').addEventListener('click', function() {
                const video = document.getElementById('camera');
                const textInput = document.getElementById('text-input').value;

        if (video.srcObject) {
        const track = video.srcObject.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);

        // 拍照并上传
        imageCapture.takePhoto()
            .then(blob => {
                // 将照片上传到服务器
                const formData = new FormData();
                formData.append('photo', blob, 'photo.jpg');
                formData.append('user_input', textInput);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch('http://127.0.0.1:8000/upload_photo/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Photo uploaded successfully:', data);

                        // 使用静态文件目录的 'photo' 子目录
                        const imagePath = '/static/photo/photo.jpg';

                        const multimodalData = new FormData();
                        multimodalData.append('image', blob, 'photo.jpg');  // 直接发送图片文件
                        multimodalData.append('user_input', textInput);  // 发送用户输入
                        multimodalData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        return fetch('http://127.0.0.1:8000/multimodal/', {
                            method: 'POST',
                            body: multimodalData
                        });
                    } else {
                        throw new Error(data.message);
                    }
                })
                .then(response => response.json())
                .then(multimodalData => {
                    document.getElementById('text-output').innerText = multimodalData.response;
                })
                .catch(error => console.error('Error:', error));
            })
            .catch(error => console.error('Error taking photo:', error));
    } else {
        console.error('Camera is not on');
    }
    });
</script>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="{% static 'js/scripts.js' %}"></script>
</body>
</html>
